#!/usr/bin/env bash

brew_compose_file="$HOME/.brew-compose.yml"
brew_compose_verbose=false

function bc-main() {
  local commands=()
  local key

  while [[ $# -gt 0 ]]; do
    key="$1"
    case $key in
      -f|--file)
        brew_compose_file="$2"
        shift
        shift
      ;;
      -v|--verbose)
        brew_compose_verbose=true
        shift
      ;;
      -h|--help)
        bc-help
        return
      ;;
      -*)
        echo "Unknown option: $key"
        return
      ;;
      *)
        commands+=("$key")
        shift
      ;;
    esac
  done

  if [ "$brew_compose_verbose" = true ]; then
    echo "v:COMPOSE_FILE = ${brew_compose_file}"
    echo "v:COMMANDS     = ${commands[@]}"
  fi

  if [ ! -f "${brew_compose_file}" ]; then
    echo "Compose file ${brew_compose_file} does not exist"
    return 1
  fi

  cmd="${commands[0]}"
  commands=("${commands[@]:1}")
  case $cmd in
    list|lis|li|l)
      bc-list "${commands[@]}"
    ;;
    install|instal|insta|inst|ins|in|i)
      bc-install "${commands[@]}"
    ;;
    *)
    echo "${cmd} is not a valid command."
    return 127
    ;;
  esac
}

function bc-help() {
cat >&2 <<EOF
Usage: brew-compose [-f <arg>...] [options] [COMMAND]

Options:
  -f, --file FILE   specify an alternate compose file
                    (default: ~/.brew-compose.yml)
  -v, --verbose     print verbose debugging information
  -h, --help        print this help

Commands
  list              list all brew formulaes in compose file
  install           install formulaes according to compose file
EOF
}

function bc-list() {
  cat $brew_compose_file
}

function bc-install() {
  brew install $(cat $brew_compose_file)
}

bc-main "$@"
